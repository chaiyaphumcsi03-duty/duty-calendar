<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duty Calendar</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Sarabun', sans-serif; margin:0; background:#f4f6f9; }
    .calendar-container { max-width:900px; margin:auto; padding:20px; }
    h2 { text-align:center; font-size:28px; margin-bottom:10px; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    button { padding:8px 12px; background:#4285F4; border:none; border-radius:6px; color:white; cursor:pointer; }

    table { width:100%; border-collapse:collapse; background:white; border-radius:10px;
            overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

    th { background:#f1f3f4; padding:12px; font-weight:600; }
    td { height:90px; text-align:right; vertical-align:top; padding:8px; cursor:pointer; position:relative; }
    td:hover { background:#e8f0fe; }

    .today { background:#d2e3fc !important; border:2px solid #4285F4; }

    .duty-box {
      position:absolute; bottom:5px; left:5px; right:5px; padding:2px 4px;
      border-radius:4px; font-size:12px; color:white; text-align:left;
    }

    .duty-panel {
      margin-top:20px; padding:15px; background:white; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:18px;
    }

  </style>
</head>
<body>

<div class="calendar-container">
  <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

  <div class="calendar-header">
    <button onclick="prevMonth()">‚¨Ö ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <div id="monthTitle" style="font-size:20px;font-weight:600;"></div>
    <button onclick="nextMonth()">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°</button>
  </div>

  <table id="calendar">
    <thead>
      <tr>
        <th>‡∏≠‡∏≤</th><th>‡∏à</th><th>‡∏≠</th><th>‡∏û</th><th>‡∏û‡∏§</th><th>‡∏®</th><th>‡∏™</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="duty-panel" id="dutyPanel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô</div>
</div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbwfojNxXY9BrD5G7kGUD1LB_BHdJo3aKySeJBGeC51_8bRE4BhDNNXa1OlYWfG1Ec1n/exec";

let dutyData = [];
let current = new Date();

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
fetch(apiURL)
  .then(res => res.json())
  .then(data => {
    dutyData = data;
    renderCalendar(current);
    autoShowTodayDuty();
  });

function renderCalendar(date) {
  const year = date.getFullYear();
  const month = date.getMonth();

  document.getElementById("monthTitle").innerText =
    date.toLocaleString("th-TH", { month:"long", year:"numeric" });

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month+1, 0).getDate();

  let tbody = "";
  let day = 1;

  for (let i = 0; i < 6; i++) {
    let row = "<tr>";

    for (let j = 0; j < 7; j++) {
      if ((i === 0 && j < firstDay) || day > lastDate) {
        row += "<td></td>";
      } else {
        let fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        let duty = dutyData.find(x => x.date === fullDate);
        let isToday = fullDate === new Date().toISOString().slice(0,10);

        row += `
<td class="${isToday ? 'today' : ''}" onclick="showDuty('${fullDate}')">
  ${day}

  ${duty && duty.photo ? `
      <img src="${duty.photo}"
           style="width:28px;height:28px;border-radius:50%;
                  position:absolute;top:5px;left:5px;object-fit:cover;">
  ` : ""}

  ${duty ? `
      <div class="duty-box" style="background:${duty.color};">
        ${duty.name}
      </div>
  ` : ""}
</td>
`;

        day++;
      }
    }
    row += "</tr>";
    tbody += row;
  }

  document.querySelector("#calendar tbody").innerHTML = tbody;
}

function showDuty(date) {
  const panel = document.getElementById("dutyPanel");
  const duty = dutyData.find(x => x.date === date);

  if (!duty) {
    panel.innerHTML = `üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThai(date)}<br>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£`;
    return;
  }

  panel.innerHTML = `
    <h3>üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThai(date)}</h3>
    <img src="${duty.photo}" style="width:90px;height:90px;border-radius:50%;"><br>
    üëÆ‚Äç‚ôÇÔ∏è <b>${duty.name}</b><br>
    üìû <a href="tel:${duty.phone}" style="font-size:20px;">${duty.phone}</a><br>
    <button onclick="window.location.href='tel:${duty.phone}'"
      style="margin-top:10px;padding:10px 20px;background:${duty.color};
      border:none;border-radius:8px;color:white;font-size:16px;">
      ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
    </button>
  `;
}

function autoShowTodayDuty() {
  showDuty(new Date().toISOString().slice(0,10));
}

function prevMonth() { current.setMonth(current.getMonth()-1); renderCalendar(current); }
function nextMonth() { current.setMonth(current.getMonth()+1); renderCalendar(current); }

function formatThai(d) {
  let [y,m,day] = d.split("-");
  const thMonths = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
  return `${parseInt(day)} ${thMonths[m-1]} ${parseInt(y)+543}`;
}
</script>

</body>
</html>
